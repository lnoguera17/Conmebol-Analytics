---
title: "Modein Conmebol"
author: "Luis Noguera"
date: "5/31/2020"
output: html_document
---

```{r setup, include=FALSE}
library(readxl)
library(tidyverse)
library(plotly)
library(tidymodels)
library(doParallel)

conmebol_raw <- read_csv("conmebol.csv") %>%
  select(-X1, -rating) 

conmebol_raw %>%
  mutate(value = parse_number(value)) %>% View()
```


# Data Cleaning

```{r}

# Cleaning the value column deleting text and getting the right value of the player.
conmebol <- conmebol_raw %>%
  mutate(value = parse_number(value), 
         value = case_when(value < 99 ~ value * 1000000, 
                           TRUE ~ value * 1000)) %>%
  na_if(., 0) %>%
  select(-height, -name)
  

# Quick view and summary of the data at hand.
skimr::skim(conmebol)

```

# Recipes and Rsample Package

## Data Split

```{r}

set.seed(415)

# Split data into training and testing data sets. 
conmebol_split <- initial_split(conmebol, prop = .8, strata = foot)
conmebol_train <- training(conmebol_split) 
conmebol_test <- testing(conmebol_split)

```



# 






## Preprocessing, feature engineering and eliminiation


```{r}

conmebol_rec <- recipe(value ~ ., data = conmebol_train) %>%
  update_role(id, new_role = "id") %>%  # Updating id roles variable
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_knnimpute(value, neighbors = 5) %>%
  #step_corr(all_numeric(), all_outcomes()) %>%
  step_normalize(all_predictors(), -all_outcomes())  
  
conmebol_prep <- conmebol_rec %>% prep()

workflow <- workflow() %>%
  add_recipe(conmebol_rec)

```



## Fitting Statistical Models - 

- Linear Regression Model
- Regularization Model - Lasso Regression
- Random Forest Model - XGBoost

### Linear Regression Model - (Using this model as baseline)



**Using Base R to fit a linear model**


```{r}

linear_fit <- lm(value ~ ., data = bake(conmebol_prep, conmebol_train))

summary(linear_fit)

```


**Tidymodels - Parsnip Package**


```{r}

# Fitting a baseline linear regression model 
linear_mod <- linear_reg(mode = 'regression') %>% 
  set_engine('lm')

# Including preprocessing steps and fitting the training data
linear_fit <- workflow %>%
  add_model(linear_mod) %>%
  fit(data = conmebol_train)

# Pulling results ad tidying from linear model and workflow. 
linear_fit %>% 
  pull_workflow_fit() %>%
  tidy() 

```

# Lasso Regression


```{r}

lasso_spec <- linear_reg(penalty = 0.1, mixture = 1) %>%
  set_engine('glmnet')

lasso_fit <- workflow %>%
  add_model(lasso_spec) %>%
  fit(data = conmebol_train)

lasso_fit %>% 
  pull_workflow_fit() %>% 
  tidy()



```


# Tuning Lasso

```{r}
set.seed(415)
doParallel::registerDoParallel()


# Creates ten folds of the training data set.
tidy_kfolds <- vfold_cv(conmebol_train)


lasso_tune <- linear_reg(
  penalty = tune(),
  mixture = 1
) %>%
  set_engine('glmnet')

lambda_grid <- grid_regular(penalty(), 
                            levels = 25)

lasso_grid <- tune_grid(
  workflow %>%
    add_model(lasso_tune),
  resamples = tidy_kfolds,
  grid = lambda_grid
)


lasso_grid %>% collect_metrics()

```


```{r}
lasso_grid %>%
  collect_metrics() %>%
  ggplot(aes(penalty, mean, color = .metric)) +
  geom_errorbar(aes(
    ymin = mean - std_err,
    ymax = mean + std_err
  ),
  alpha = 0.5
  ) +
  geom_line(size = 1.5) +
  facet_wrap(~.metric, scales = "free", nrow = 2) +
  scale_x_log10() +
  theme(legend.position = "none")
```




```{r}


rf_spec <- rand_forest(
  min_n = tune(),
  
)




```

